datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPER_ADMIN
  HOSPITAL_ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  SALES_PERSON
  LAB_TECHNICIAN
  PHARMACIST
}

enum RegistrationMode {
  OPD
  IPD
  EMERGENCY
}

enum RegistrationSource {
  WALK_IN
  REFERRAL
  DIGITAL
  AFFILIATE
}

enum Status {
  ACTIVE
  INACTIVE
}

enum PatientDoc {
  PHOTO
  ID_PROOF
  INSURANCE_CARD
  PRESCRIPTION
  LAB_REPORT
  OTHER
}

enum Relation {
  PARENT_CHILD
  SPOUSE
  SIBLING
}

enum MaritalStatus {
  BACHELOR
  MARRIED
  DIVORCED
  WIDOWED
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  DIAGNOSED
  PENDING
}

enum VisitType {
  OPD
  IPD
  ER
  FOLLOW_UP
}

enum VitalType {
  BP_SYSTOLIC
  BP_DIASTOLIC
  HEART_RATE
  TEMPERATURE
  WEIGHT
  HEIGHT
  SPO2
  RESPIRATORY_RATE
}

enum AppointmentAttachType {
  PRESCRIPTION
  MEDICAL_REPORT
  OTHER
}

enum ShiftName {
  GENERAL
  NIGHT
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum SurgicalStatus {
  NOT_REQUIRED
  NOT_CONFIRMED
  CONFIRMED
  CANCELLED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

/// Tracks processing status of an ordered lab test
enum LabTestStatus {
  PENDING
  PROCESSING
  COMPLETED
  SENT_EXTERNAL
}

/// IPD System Enums
enum IPDStatus {
  QUEUED
  ADMITTED
  DISCHARGED
  TRANSFERRED
}

enum InsuranceType {
  CASHLESS
  REIMBURSEMENT
  NA
}

enum WardType {
  GENERAL
  ICU
  PRIVATE
  SEMI_PRIVATE
  EMERGENCY
}

enum WardSubType {
  AC
  NON_AC
  SINGLE
  DOUBLE
  TRIPLE
  QUADRUPLE
}

enum InsuranceVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
  UNDER_REVIEW
}

enum InsuranceDocumentType {
  POLICY_CARD
  ID_CARD
  AUTHORIZATION_LETTER
  MEDICAL_REPORTS
  PRESCRIPTION
  OTHER
}

enum PatientDocumentCategory {
  MEDICAL_REPORTS
  LAB_REPORTS
  IMAGING_REPORTS
  PRESCRIPTION
  CONSENT_FORMS
  DISCHARGE_SUMMARY
  REFERRAL_LETTERS
  INSURANCE_DOCUMENTS
  ID_PROOF
  EMERGENCY_CONTACT
  OTHER
}

enum DocumentStatus {
  UPLOADED
  PROCESSING
  VERIFIED
  REJECTED
  ARCHIVED
}

model SuperAdmin {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  status    Status   @default(ACTIVE)
  role      UserRole @default(SUPER_ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Hospital {
  id            String   @id @default(uuid())
  name          String
  address       String
  contactNumber String
  email         String
  latitude      Float?
  longitude     Float?
  googlePlaceId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  status        Status   @default(ACTIVE)

  admins       HospitalAdmin[]
  patients     Patient[]
  staff        HospitalStaff[]
  appointments Appointment[]
  shifts       Shift[]
  departments  Department[]
  opdCharges   OpdCharge[]
  labCharges   LabCharge[]
  tempShifts   TempShift[]
  bills        Bill[]
  ipdQueues    IPDQueue[]
  insuranceCompanies InsuranceCompany[]
  wards        Ward[]
  prescriptions Prescription[]
}

model Department {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff HospitalStaff[]

  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  hospitalId String

  @@index([hospitalId])
}

model HospitalAdmin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  status    Status   @default(ACTIVE)
  role      UserRole @default(HOSPITAL_ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  hospitalId String

  @@index([hospitalId])
}

model HospitalStaff {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String
  name           String
  role           UserRole
  specialisation String?
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  shifts              Shift[]
  templates           DiseaseTemplate[]
  appointments        Appointment[]     @relation("DoctorAppointments")
  opdCharge           OpdCharge?
  slots               Slot[]
  tempShifts          TempShift[]
  createdAppointments Appointment[]     @relation("AppointmentCreator")
  createdIPDQueues    IPDQueue[]
  assignedIPDAdmissions IPDAdmission[]
  ipdVisits           IPDVisit[]
  uploadedInsuranceDocuments InsuranceDocument[]
  verifiedInsuranceVerifications InsuranceVerification[]
  createdDocumentFolders PatientDocumentFolder[]
  uploadedPatientDocuments PatientDocumentFile[]
  documentAccessLogs DocumentAccessLog[]
  prescriptions       Prescription[]
  createdPatients     Patient[] @relation("PatientCreator")
  uploadedIPDPatientDocuments IPDPatientDocument[]

  hospital   Hospital   @relation(fields: [hospitalId], references: [id])
  hospitalId String
  dept       Department @relation(fields: [deptId], references: [id])
  deptId     String

  @@index([hospitalId])
}

model Slot {
  id        String   @id @default(uuid())
  timeSlot  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor         HospitalStaff @relation(fields: [doctorId], references: [id])
  doctorId       String
  appointment1   Appointment   @relation("SlotAppointment1", fields: [appointment1Id], references: [id])
  appointment1Id String        @unique
  appointment2   Appointment?  @relation("SlotAppointment2", fields: [appointment2Id], references: [id])
  appointment2Id String?       @unique

  @@unique([doctorId, timeSlot])
  @@index([doctorId])
  @@index([timeSlot])
  @@index([appointment1Id])
  @@index([appointment2Id])
}

model TempShift {
  id        String   @id @default(uuid())
  startTime DateTime
  endTime   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    Status   @default(ACTIVE)

  hospital   Hospital      @relation(fields: [hospitalId], references: [id])
  hospitalId String
  staff      HospitalStaff @relation(fields: [staffId], references: [id])
  staffId    String

  @@index([hospitalId])
  @@index([staffId])
}

model Shift {
  id        String    @id @default(uuid())
  shiftName ShiftName
  day       WeekDay
  startTime String
  endTime   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  status    Status    @default(ACTIVE)

  hospital   Hospital      @relation(fields: [hospitalId], references: [id])
  hospitalId String
  staff      HospitalStaff @relation(fields: [staffId], references: [id])
  staffId    String

  @@index([hospitalId])
  @@index([staffId])
}

model Patient {
  id                        String             @id @default(uuid())
  patientUniqueId           String             @unique @default(cuid())
  uhid                      String?            @unique // Universal Health ID
  name                      String
  dob                       DateTime
  gender                    Gender
  phone                     String
  status                    Status             @default(ACTIVE)
  registrationMode          RegistrationMode
  registrationSource        RegistrationSource
  registrationSourceDetails String?
  referralPersonName        String? // Name of the person who referred (for REFERRAL source)

  maritalStatus         MaritalStatus?
  address               String?
  preExistingCondition  String?
  chronicDisease        String?
  email                 String?
  emergencyContactName  String?
  emergencyContactPhone String?
  allergy               String?
  bloodGroup            BloodGroup?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // Creator tracking
  createdBy   String?
  creator     HospitalStaff? @relation("PatientCreator", fields: [createdBy], references: [id])

  documents           PatientDocument[]
  relativesAdded      PatientFamilyLink[]  @relation("PatientToRelatives")
  relativeOfOthers    PatientFamilyLink[]  @relation("RelativeOfPatient")
  appointments        Appointment[]
  appointmentLabTests AppointmentLabTest[]
  bills               Bill[]
  insurances          Insurance[]
  ipdQueues           IPDQueue[]
  documentFolders     PatientDocumentFolder[]
  documentFiles       PatientDocumentFile[]
  prescriptions       Prescription[]

  hospital   Hospital   @relation(fields: [hospitalId], references: [id])
  hospitalId String
  LabOrder   LabOrder[]

  @@index([hospitalId])
  @@index([patientUniqueId])
  @@index([uhid])
}

model PatientDocument {
  id         String     @id @default(uuid())
  type       PatientDoc
  url        String
  uploadedAt DateTime   @default(now())

  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String

  @@index([patientId])
}

model PatientFamilyLink {
  id           String   @id @default(uuid())
  relationship Relation

  patient    Patient @relation("PatientToRelatives", fields: [patientId], references: [id])
  patientId  String
  relative   Patient @relation("RelativeOfPatient", fields: [relativeId], references: [id])
  relativeId String

  @@unique([patientId, relativeId])
  @@index([patientId])
  @@index([relativeId])
}

model Appointment {
  id          String            @id @default(uuid())
  visitId     String?           @unique // Visit ID for this appointment
  scheduledAt DateTime
  visitType   VisitType
  status      AppointmentStatus @default(SCHEDULED)
  source      String?           // Track the source of appointment booking (WEBSITE, GMB, INTERNAL, etc.)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   String? 
  creator     HospitalStaff?    @relation("AppointmentCreator", fields: [createdBy], references: [id])
  reminderSent Boolean          @default(false) // Track if 3-hour reminder has been sent

  vitals          Vital[]
  attachments     AppointmentAttachment[]
  diagnosisRecord DiagnosisRecord?        @relation("appointmentDiagnosis")
  followUpFrom    DiagnosisRecord?        @relation("followUpFromDiagnosis")
  surgery         Surgery?
  slotAsFirst     Slot?                   @relation("SlotAppointment1")
  slotAsSecond    Slot?                   @relation("SlotAppointment2")

  patient    Patient       @relation(fields: [patientId], references: [id])
  patientId  String
  doctor     HospitalStaff @relation("DoctorAppointments", fields: [doctorId], references: [id])
  doctorId   String
  hospital   Hospital      @relation(fields: [hospitalId], references: [id])
  hospitalId String

  labTests AppointmentLabTest[]
  bills    Bill[]
  LabOrder LabOrder[]

  @@index([patientId])
  @@index([doctorId])
  @@index([hospitalId])
  @@index([createdBy])
  @@index([visitId])
  @@index([source])
}

/// — Lab order to group multiple lab tests ordered together —
model LabOrder {
  id            String       @id @default(uuid())
  patient       Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId     String
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?
  orderedBy     String? // Name of the person who ordered (doctor/receptionist)
  orderDate     DateTime     @default(now())
  notes         String? // Additional notes for the entire order
  urgentOrder   Boolean      @default(false)
  status        String       @default("PENDING") // PENDING, PROCESSING, COMPLETED, CANCELLED
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Optional billing relationship
  bill   Bill?   @relation(fields: [billId], references: [id])
  billId String?

  // Related lab tests
  appointmentLabTests AppointmentLabTest[]

  @@index([patientId])
  @@index([appointmentId])
  @@index([orderDate])
  @@index([status])
  @@index([billId])
}

/// — Static master list of all lab tests conducted —
model LabTest {
  id          String   @id @default(uuid())
  code        String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sampleType  String?
  charge      Float    @default(0)

  diseaseTemplate DiseaseTemplate[]
  parameters      LabTestParameter[]
  orders          AppointmentLabTest[]
}

/// — Static definitions of each parameter for a given test —
model LabTestParameter {
  id         String   @id @default(uuid())
  labTest    LabTest  @relation(fields: [labTestId], references: [id], onDelete: Cascade)
  labTestId  String
  name       String // e.g. "Hemoglobin"
  unit       String? // e.g. "g/dL"
  lowerLimit Float? // e.g. 13
  upperLimit Float? // e.g. 17
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  results AppointmentLabTestResult[]

  @@unique([labTestId, name])
  @@index([labTestId])
}

model AppointmentLabTestAttachment {
  id                   String             @id @default(uuid())
  appointmentLabTest   AppointmentLabTest @relation(fields: [appointmentLabTestId], references: [id], onDelete: Cascade)
  appointmentLabTestId String
  url                  String
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}

/// — Each ordered test on a specific appointment —
model AppointmentLabTest {
  id                  String        @id @default(uuid())
  appointment         Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  appointmentId       String?
  referredFromOutside Boolean       @default(false)
  patient             Patient?      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId           String?
  labTest             LabTest       @relation(fields: [labTestId], references: [id])
  labTestId           String
  isSentExternal      Boolean       @default(false)
  externalLabName     String?
  status              LabTestStatus @default(PENDING)
  tentativeReportDate DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  results     AppointmentLabTestResult[]
  attachments AppointmentLabTestAttachment[]
  billItems   BillItem[]
  LabOrder    LabOrder?                      @relation(fields: [labOrderId], references: [id])
  labOrderId  String?

  @@index([appointmentId])
  @@index([labTestId])
  @@index([status])
  @@index([labOrderId])
}

/// — One row per (ordered test × parameter) with the actual measured value —
model AppointmentLabTestResult {
  id                   String             @id @default(uuid())
  appointmentLabTest   AppointmentLabTest @relation(fields: [appointmentLabTestId], references: [id], onDelete: Cascade)
  appointmentLabTestId String
  parameter            LabTestParameter   @relation(fields: [parameterId], references: [id], onDelete: Restrict)
  parameterId          String

  value        Float
  unitOverride String? // override static unit if needed
  notes        String?

  /// optional link to the stored report (AppointmentAttachment.type = MEDICAL_REPORT)
  reportAttachment AppointmentAttachment? @relation(fields: [attachmentId], references: [id])
  attachmentId     String?                @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([appointmentLabTestId, parameterId])
  @@index([appointmentLabTestId])
  @@index([parameterId])
}

model DiagnosisRecord {
  id        String   @id @default(uuid())
  diagnosis String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  medicines Json

  appointment   Appointment @relation("appointmentDiagnosis", fields: [appointmentId], references: [id], onDelete: Cascade)
  appointmentId String      @unique

  followUpAppointment   Appointment? @relation("followUpFromDiagnosis", fields: [followUpAppointmentId], references: [id])
  followUpAppointmentId String?      @unique
}

model Vital {
  id         String    @id @default(uuid())
  type       VitalType
  value      Float
  recordedAt DateTime  @default(now())
  unit       String?
  notes      String?

  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  appointmentId String

  @@index([appointmentId])
}

model AppointmentAttachment {
  id        String                @id @default(uuid())
  type      AppointmentAttachType
  url       String
  createdAt DateTime              @default(now())

  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  appointmentId String

  labTestResult AppointmentLabTestResult?

  @@index([appointmentId])
}

model LabCharge {
  id        String   @id @default(uuid())
  test      String
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  hospitalId String
}

/// — Billing Module Models —

enum BillStatus {
  DRAFT
  GENERATED
  SENT
  PAID
  OVERDUE
  CANCELLED
  PARTIALLY_PAID
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  INSURANCE
  CHEQUE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum BillType {
  OPD_CONSULTATION
  LAB_TEST
  SURGERY
  MEDICINE
  ROOM_CHARGE
  PROCEDURE
  EMERGENCY
  FOLLOW_UP
}

/// — Main billing entity that combines all charges for a patient —
model Bill {
  id          String     @id @default(uuid())
  billNumber  String     @unique
  patientId   String
  hospitalId  String
  totalAmount Float
  paidAmount  Float      @default(0)
  dueAmount   Float
  status      BillStatus @default(DRAFT)
  billDate    DateTime   @default(now())
  dueDate     DateTime?
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  patient       Patient      @relation(fields: [patientId], references: [id])
  hospital      Hospital     @relation(fields: [hospitalId], references: [id])
  billItems     BillItem[]
  payments      Payment[]
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?
  labOrders     LabOrder[]

  @@index([patientId])
  @@index([hospitalId])
  @@index([status])
  @@index([billDate])
}

/// — Individual items in a bill —
model BillItem {
  id             String   @id @default(uuid())
  billId         String
  itemType       BillType
  description    String
  quantity       Int      @default(1)
  unitPrice      Float
  totalPrice     Float
  discountAmount Float    @default(0)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  // Optional relations to existing entities
  labTest   AppointmentLabTest? @relation(fields: [labTestId], references: [id])
  labTestId String?
  surgery   Surgery?            @relation(fields: [surgeryId], references: [id])
  surgeryId String?

  @@index([billId])
  @@index([itemType])
}

/// — Payment transactions —
model Payment {
  id            String        @id @default(uuid())
  billId        String
  amount        Float
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  paymentDate   DateTime      @default(now())
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId])
  @@index([status])
  @@index([paymentDate])
}

/// — Insurance claims and coverage —
model Insurance {
  id             String   @id @default(uuid())
  patientId      String
  providerName   String
  policyNumber   String
  coverageType   String
  coverageAmount Float
  validFrom      DateTime
  validTo        DateTime
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([isActive])
}

/// — Discounts and offers —
model Discount {
  id           String   @id @default(uuid())
  code         String   @unique
  description  String
  discountType String // PERCENTAGE or FIXED_AMOUNT
  value        Float
  maxDiscount  Float?
  minAmount    Float?
  validFrom    DateTime
  validTo      DateTime
  isActive     Boolean  @default(true)
  usageLimit   Int?
  usedCount    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([validFrom, validTo])
}

model OpdCharge {
  id        String   @id @default(uuid())
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor     HospitalStaff @relation(fields: [doctorId], references: [id])
  doctorId   String        @unique
  hospital   Hospital      @relation(fields: [hospitalId], references: [id])
  hospitalId String

  @@index([doctorId])
  @@index([hospitalId])
}

model DiseaseTemplate {
  id            String    @id @default(uuid())
  name          String
  medicines     Json
  labTests      LabTest[]
  clinicalNotes Json?

  doctor   HospitalStaff @relation(fields: [doctorId], references: [id])
  doctorId String

  @@index([doctorId])
}

model Surgery {
  id          String         @id @default(uuid())
  category    String
  description String?
  scheduledAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  status      SurgicalStatus @default(NOT_CONFIRMED)

  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  appointmentId String      @unique
  billItems     BillItem[]

  @@index([appointmentId])
}

/// — UHID Sequence Tracker for universal sequence across TRUE ecosystem —
model UhidSequence {
  id        String   @id @default(uuid())
  yearCode  String   // Year code (e.g., "25")
  sequence  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([yearCode])
  @@index([yearCode])
}

/// — IPD System Models —

/// IPD Queue Management
model IPDQueue {
  id        String   @id @default(uuid())
  ipdNumber String   @unique
  status    IPDStatus @default(QUEUED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String
  
  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  hospitalId String
  
  createdBy   HospitalStaff @relation(fields: [createdById], references: [id])
  createdById String
  
  admission   IPDAdmission?
  
  @@index([patientId])
  @@index([hospitalId])
  @@index([status])
  @@index([createdById])
}

/// IPD Admission Details
model IPDAdmission {
  id        String   @id @default(uuid())
  admissionDate DateTime @default(now())
  dischargeDate DateTime?
  status    IPDStatus @default(ADMITTED)
  
  // Insurance details
  insuranceType InsuranceType @default(NA)
  insuranceCompany String?
  policyNumber String?
  tpaName String?
  insuranceCardUrl String? // For uploaded insurance card
  insuranceNumber String? // Alternative insurance number if policy number not available
  
  // Ward details
  wardType WardType
  wardSubType WardSubType?
  roomNumber String?
  bedNumber String?
  
  // Medical details
  chiefComplaint String?
  admissionNotes String?
  dischargeNotes String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  queue   IPDQueue @relation(fields: [queueId], references: [id])
  queueId String @unique
  
  assignedDoctor   HospitalStaff @relation(fields: [assignedDoctorId], references: [id])
  assignedDoctorId String
  
  bed     Bed? @relation(fields: [bedId], references: [id])
  bedId   String?
  
  visits IPDVisit[]
  dischargeSummary IPDDischargeSummary?
  insuranceDocuments InsuranceDocument[]
  insuranceVerification InsuranceVerification?
  patientDocuments IPDPatientDocument[]
  prescriptions Prescription[]
  patientDocumentFiles PatientDocumentFile[]
  
  @@index([queueId])
  @@index([assignedDoctorId])
  @@index([status])
}

/// IPD Doctor Visits
model IPDVisit {
  id        String   @id @default(uuid())
  visitDate DateTime @default(now())
  visitNotes String
  clinicalObservations String?
  treatmentGiven String?
  medicationChanges String?
  patientResponse String?
  nextVisitPlan String?
  
  admission   IPDAdmission @relation(fields: [admissionId], references: [id])
  admissionId String
  
  doctor   HospitalStaff @relation(fields: [doctorId], references: [id])
  doctorId String
  
  vitals IPDVisitVital[]
  prescriptions Prescription[]
  
  @@index([admissionId])
  @@index([doctorId])
}

/// IPD Visit Vitals
model IPDVisitVital {
  id         String    @id @default(uuid())
  type       VitalType
  value      Float
  unit       String?
  notes      String?
  recordedAt DateTime  @default(now())
  
  visit   IPDVisit @relation(fields: [visitId], references: [id])
  visitId String
  
  @@index([visitId])
}

/// IPD Discharge Summary
model IPDDischargeSummary {
  id        String   @id @default(uuid())
  summaryDate DateTime @default(now())
  
  // Admission details
  admissionDate DateTime
  dischargeDate DateTime
  totalStayDuration Int // in days
  
  // Medical details
  chiefComplaint String
  finalDiagnosis String
  treatmentSummary String
  proceduresPerformed String?
  medicationsPrescribed String
  followUpInstructions String
  
  // Doctor details
  doctorSignature String?
  hospitalStamp String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  admission   IPDAdmission @relation(fields: [admissionId], references: [id])
  admissionId String @unique
  
  @@index([admissionId])
}

/// Insurance Companies
model InsuranceCompany {
  id        String   @id @default(uuid())
  name      String
  isPartnered Boolean @default(false)
  tpaName   String?
  contactInfo String?
  
  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  hospitalId String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([hospitalId])
}

/// Ward Management
model Ward {
  id        String   @id @default(uuid())
  name      String
  type      WardType
  subType   WardSubType?
  totalBeds Int
  occupiedBeds Int @default(0)
  availableBeds Int
  pricePerDay Float?
  description String?
  
  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  hospitalId String
  
  beds      Bed[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([hospitalId])
  @@index([type])
}

model Bed {
  id        String   @id @default(uuid())
  bedNumber String   // e.g., "1", "2", "3" or "A", "B", "C"
  isOccupied Boolean @default(false)
  pricePerDay Float?
  
  ward      Ward @relation(fields: [wardId], references: [id])
  wardId    String
  
  admissions IPDAdmission[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([wardId, bedNumber])
  @@index([wardId])
}

/// Insurance Document Management
model InsuranceDocument {
  id        String   @id @default(uuid())
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  documentType InsuranceDocumentType
  uploadedAt DateTime @default(now())
  
  // Relations
  admission   IPDAdmission @relation(fields: [admissionId], references: [id])
  admissionId String
  
  uploadedBy   HospitalStaff @relation(fields: [uploadedById], references: [id])
  uploadedById String
  
  @@index([admissionId])
  @@index([uploadedById])
}

/// IPD Patient Document Management
model IPDPatientDocument {
  id        String   @id @default(uuid())
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  category  PatientDocumentCategory
  description String?
  uploadedAt DateTime @default(now())
  
  // Relations
  admission IPDAdmission @relation(fields: [admissionId], references: [id])
  admissionId String
  
  uploadedBy   HospitalStaff @relation(fields: [uploadedById], references: [id])
  uploadedById String
  
  @@index([admissionId])
  @@index([uploadedById])
}

/// Insurance Verification Tracking
model InsuranceVerification {
  id        String   @id @default(uuid())
  verificationStatus InsuranceVerificationStatus @default(PENDING)
  verificationDate DateTime?
  verifiedBy String? // Name of person who verified
  verificationNotes String?
  policyValidFrom DateTime?
  policyValidTo DateTime?
  coverageAmount Float?
  deductibleAmount Float?
  coPaymentPercentage Float?
  preAuthorizationRequired Boolean @default(false)
  preAuthorizationNumber String?
  preAuthorizationDate DateTime?
  preAuthorizationExpiry DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  admission   IPDAdmission @relation(fields: [admissionId], references: [id])
  admissionId String @unique
  
  verifiedByStaff   HospitalStaff? @relation(fields: [verifiedByStaffId], references: [id])
  verifiedByStaffId String?
  
  @@index([admissionId])
  @@index([verificationStatus])
}

/// Patient Document Management System
model PatientDocumentFolder {
  id        String   @id @default(uuid())
  folderName String
  description String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String
  
  createdBy   HospitalStaff @relation(fields: [createdById], references: [id])
  createdById String
  
  documents PatientDocumentFile[]
  
  @@index([patientId])
  @@index([createdById])
}

model PatientDocumentFile {
  id        String   @id @default(uuid())
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  category  PatientDocumentCategory
  status    DocumentStatus @default(UPLOADED)
  version   Int      @default(1)
  description String?
  tags      String[] // Array of tags for better organization
  uploadedAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String
  
  folder   PatientDocumentFolder? @relation(fields: [folderId], references: [id])
  folderId String?
  
  uploadedBy   HospitalStaff @relation(fields: [uploadedById], references: [id])
  uploadedById String
  
  // Optional relation to IPD admission
  admission   IPDAdmission? @relation(fields: [admissionId], references: [id])
  admissionId String?
  
  // Document history for version control
  previousVersion   PatientDocumentFile? @relation("DocumentVersion", fields: [previousVersionId], references: [id])
  previousVersionId String?
  nextVersions      PatientDocumentFile[] @relation("DocumentVersion")
  
  // Access logs
  accessLogs        DocumentAccessLog[]
  
  @@index([patientId])
  @@index([folderId])
  @@index([uploadedById])
  @@index([admissionId])
  @@index([category])
  @@index([status])
}

model DocumentAccessLog {
  id        String   @id @default(uuid())
  action    String   // VIEW, DOWNLOAD, UPDATE, DELETE
  accessedAt DateTime @default(now())
  ipAddress String?
  userAgent String?
  
  // Relations
  document   PatientDocumentFile @relation(fields: [documentId], references: [id])
  documentId String
  
  accessedBy   HospitalStaff @relation(fields: [accessedById], references: [id])
  accessedById String
  
  @@index([documentId])
  @@index([accessedById])
  @@index([accessedAt])
}

// ========================================
// PRESCRIPTION SYSTEM MODELS
// ========================================

enum DrugCategory {
  ANTIBIOTIC
  ANALGESIC
  ANTI_INFLAMMATORY
  CARDIOVASCULAR
  RESPIRATORY
  GASTROINTESTINAL
  NEUROLOGICAL
  PSYCHIATRIC
  ENDOCRINE
  DERMATOLOGICAL
  OPHTHALMOLOGICAL
  GYNECOLOGICAL
  PEDIATRIC
  EMERGENCY
  VITAMIN_SUPPLEMENT
  OTHER
}

enum DrugForm {
  TABLET
  CAPSULE
  SYRUP
  INJECTION
  CREAM
  OINTMENT
  DROPS
  INHALER
  PATCH
  SUPPOSITORY
  POWDER
  GEL
  LOTION
  SPRAY
  OTHER
}

enum PrescriptionStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum PrescriptionItemStatus {
  PENDING
  DISPENSED
  PARTIALLY_DISPENSED
  CANCELLED
  OUT_OF_STOCK
}

model Drug {
  id          String       @id @default(uuid())
  name        String       @unique
  genericName String?
  brandName   String?
  category    DrugCategory
  form        DrugForm
  strength    String       // e.g., "500mg", "10ml"
  unit        String       // e.g., "mg", "ml", "tablets"
  description String?
  
  // Drug properties
  isControlledSubstance Boolean @default(false)
  requiresPrescription  Boolean @default(true)
  isActive              Boolean @default(true)
  
  // Stock information
  currentStock    Int @default(0)
  minimumStock    Int @default(0)
  maximumStock    Int @default(0)
  reorderLevel    Int @default(0)
  
  // Pricing
  unitPrice       Float?
  costPrice       Float?
  
  // Drug interactions and contraindications
  contraindications String?
  sideEffects       String?
  warnings          String?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  prescriptionItems PrescriptionItem[]
  drugInteractions  DrugInteraction[] @relation("Drug1")
  drugInteractions2 DrugInteraction[] @relation("Drug2")
  
  @@index([name])
  @@index([category])
  @@index([isActive])
  @@index([isControlledSubstance])
}

model DrugInteraction {
  id          String @id @default(uuid())
  severity    String // MILD, MODERATE, SEVERE
  description String
  action      String // AVOID, MONITOR, DOSE_ADJUSTMENT
  
  // Relations
  drug1   Drug   @relation("Drug1", fields: [drug1Id], references: [id])
  drug1Id String
  
  drug2   Drug   @relation("Drug2", fields: [drug2Id], references: [id])
  drug2Id String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([drug1Id, drug2Id])
  @@index([drug1Id])
  @@index([drug2Id])
}

model Prescription {
  id          String            @id @default(uuid())
  prescriptionNumber String     @unique
  status      PrescriptionStatus @default(DRAFT)
  
  // Patient and doctor information
  patientId   String
  doctorId    String
  hospitalId  String
  
  // Prescription details
  diagnosis   String?
  notes       String?
  instructions String?
  
  // Validity
  validFrom   DateTime @default(now())
  validUntil  DateTime
  
  // IPD integration
  admissionId String?
  visitId     String?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  patient     Patient            @relation(fields: [patientId], references: [id])
  doctor      HospitalStaff      @relation(fields: [doctorId], references: [id])
  hospital    Hospital           @relation(fields: [hospitalId], references: [id])
  admission   IPDAdmission?      @relation(fields: [admissionId], references: [id])
  visit       IPDVisit?          @relation(fields: [visitId], references: [id])
  items       PrescriptionItem[]
  history     PrescriptionHistory[]
  
  @@index([patientId])
  @@index([doctorId])
  @@index([hospitalId])
  @@index([admissionId])
  @@index([visitId])
  @@index([status])
  @@index([validUntil])
}

model PrescriptionItem {
  id             String                 @id @default(uuid())
  prescriptionId String
  drugId         String
  
  // Dosage information
  dosage         String  // e.g., "500mg"
  frequency      String  // e.g., "Twice daily", "Every 8 hours"
  duration       String  // e.g., "7 days", "Until symptoms resolve"
  quantity       Int     // Total quantity prescribed
  unit           String  // e.g., "tablets", "ml"
  
  // Administration details
  route          String? // e.g., "Oral", "IV", "Topical"
  timing         String? // e.g., "Before meals", "At bedtime"
  specialInstructions String?
  
  // Status tracking
  status         PrescriptionItemStatus @default(PENDING)
  dispensedQuantity Int @default(0)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  drug         Drug         @relation(fields: [drugId], references: [id])
  
  @@index([prescriptionId])
  @@index([drugId])
  @@index([status])
}

model PrescriptionHistory {
  id             String @id @default(uuid())
  prescriptionId String
  action         String // CREATED, UPDATED, DISPENSED, CANCELLED, EXPIRED
  description    String?
  performedBy    String
  performedAt    DateTime @default(now())
  
  // Relations
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  
  @@index([prescriptionId])
  @@index([performedAt])
}
